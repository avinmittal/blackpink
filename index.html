<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Playback</title>

<link rel="preconnect" href="https://www.youtube.com">
<link rel="preconnect" href="https://www.youtube-nocookie.com">
<link rel="preconnect" href="https://www.google.com">
<link rel="preconnect" href="https://i.ytimg.com">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  height: 100%;
  overflow: hidden;
}

/* Fullscreen container */
#stage {
  position: fixed;
  inset: 0;
  background: black;
}

/* Player fills screen */
#player {
  width: 100%;
  height: 100%;
}

/* Fade overlay (snappy) */
#fade {
  position: fixed;
  inset: 0;
  background: black;
  pointer-events: none;
  opacity: 0;
  transition: opacity 150ms linear; /* snappy */
}
#fade.on { opacity: 1; }

/* Minimal fullscreen button */
#fsBtn {
  position: fixed;
  top: 14px;
  right: 14px;
  z-index: 9999;
  background: rgba(0,0,0,0.55);
  color: white;
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 14px;
  line-height: 1;
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
}
#fsBtn:active { transform: scale(0.98); }
</style>
</head>
<body>

<div id="stage">
  <div id="player"></div>
</div>
<div id="fade"></div>

<button id="fsBtn" aria-label="Fullscreen">â›¶</button>

<script>
const segments = [
  { videoId: "IHNzOHi8sJs", start: 0,  end: 24 },
  { videoId: "IHNzOHi8sJs", start: 66, end: 94 },
  { videoId: "2S24-y0Ij3Y", start: 59, end: 92 },
  { videoId: "bwmSjveL3Lc", start: 0,  end: 55 },
  { videoId: "bwmSjveL3Lc", start: 82, end: 113 }
];

// iOS tuning
const END_MARGIN_SEC = 0.14;
const POLL_MS = 140;

// Snappy fade tuning
const FADE_OUT_AT_END_SEC = 0.20;  // start fade shortly before cut
const FADE_IN_AFTER_PLAY_MS = 60;  // remove black quickly after playback resumes

let player;
let segIndex = 0;
let monitoring = false;
let rafId = null;
let intervalId = null;
let started = false;
let fadingOut = false;

const fadeEl = document.getElementById("fade");

// Load IFrame API
const tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
document.head.appendChild(tag);

window.onYouTubeIframeAPIReady = () => {
  player = new YT.Player("player", {
    host: "https://www.youtube-nocookie.com",
    videoId: segments[0].videoId,
    playerVars: {
      playsinline: 1,
      rel: 0,
      modestbranding: 1,
      controls: 0,
      fs: 0,
      disablekb: 1,
      origin: window.location.origin
    },
    events: { onStateChange }
  });
};

function onStateChange(e) {
  if (e.data === YT.PlayerState.PLAYING) {
    startMonitoring();
    setTimeout(() => fadeOff(), FADE_IN_AFTER_PLAY_MS);
  }

  if (e.data === YT.PlayerState.BUFFERING) stopMonitoring();
  if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED)
    stopMonitoring();
}

function fadeOn() { fadeEl.classList.add("on"); }
function fadeOff() {
  fadeEl.classList.remove("on");
  fadingOut = false;
}

function stopMonitoring() {
  monitoring = false;
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;
  if (intervalId) clearInterval(intervalId);
  intervalId = null;
}

function startMonitoring() {
  if (monitoring) return;
  monitoring = true;

  const check = () => {
    if (!monitoring) return;

    const s = segments[segIndex];
    const t = safeTime();

    if (!fadingOut && (s.end - t) <= FADE_OUT_AT_END_SEC) {
      fadingOut = true;
      fadeOn();
    }

    if (t >= s.end - END_MARGIN_SEC) {
      nextSegment();
      return;
    }

    rafId = requestAnimationFrame(check);
  };

  rafId = requestAnimationFrame(check);

  intervalId = setInterval(() => {
    if (!monitoring) return;
    const s = segments[segIndex];
    const t = safeTime();

    if (!fadingOut && (s.end - t) <= FADE_OUT_AT_END_SEC) {
      fadingOut = true;
      fadeOn();
    }

    if (t >= s.end - END_MARGIN_SEC) nextSegment();
  }, POLL_MS);
}

function safeTime() {
  try { return player.getCurrentTime() || 0; }
  catch { return 0; }
}

function currentVideoId() {
  try { return player.getVideoData().video_id || ""; }
  catch { return ""; }
}

function playSegment(i) {
  segIndex = i;
  const s = segments[segIndex];
  stopMonitoring();

  // always fade during jump to hide stutter
  fadeOn();

  const cur = currentVideoId();

  if (cur && cur === s.videoId) {
    try {
      player.seekTo(s.start, true);
      player.playVideo();
      return;
    } catch {}
  }

  player.loadVideoById({ videoId: s.videoId, startSeconds: s.start });
}

function nextSegment() {
  stopMonitoring();
  const next = segIndex + 1;

  if (next >= segments.length) {
    fadeOn();
    try { player.pauseVideo(); } catch {}
    return;
  }

  playSegment(next);
}

function requestFullscreen() {
  // iOS prefers user gesture; our button provides that.
  const elem = document.documentElement;
  if (document.fullscreenElement || document.webkitFullscreenElement) return;

  if (elem.requestFullscreen) elem.requestFullscreen();
  else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
}

function startPlayback() {
  if (started) return;
  started = true;
  // try fullscreen on first tap (may or may not work depending on iOS)
  requestFullscreen();
  fadeOn();
  playSegment(0);
}

// Tap anywhere once to start
document.addEventListener("click", startPlayback, { once: true });
document.addEventListener("touchstart", startPlayback, { once: true });

// Fullscreen button
document.getElementById("fsBtn").addEventListener("click", (e) => {
  e.stopPropagation(); // don't trigger startPlayback twice
  requestFullscreen();
});
</script>

</body>
</html>
